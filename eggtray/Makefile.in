# Makefile for ups-monitor's eggtray
# ripped from rhn-applet
#
# Arnaud Quette <http://arnaud.quette.free.fr/contact.html>


PYLIBFILES      = eggtrayiconmodule.so

OBJECTS		= $(PYLIBFILES)

DIST_SOURCES = 	eggtrayicon.c \
		eggtrayicon.h \
		eggtrayiconmodule.c

DISTFILES = $(DIST_SOURCES)

# Dirs we need to walk into
SUBDIRS		= 

# Compilation stuff
CC		= gcc
PYTHON_VERSION	= $(shell echo `python -c "import sys; print sys.version[0:3]"`)
PYTHON_INCLUDE	= -I/usr/include/python$(PYTHON_VERSION) \
                  @EGG_CFLAGS@
LIBS            = @EGG_LIBS@$(shell pkg-config gtk+-2.0 --libs) \
                  $(shell pkg-config libgnomeui-2.0 --libs)
CFLAGS		= -Wall -g -fomit-frame-pointer $(PYTHON_INCLUDE)
PYCHECKER	= /usr/bin/pychecker

# Directories for installation
RHNSHARE_DIR    = $(DESTDIR)/$(PREFIX)/usr/share/ups-monitor
# all dirs
DIRS		= $(BIN_DIR) $(PIXMAP_DIR)

# INSTALL scripts 
INSTALL         = install --verbose 
INSTALL_BIN     = $(INSTALL) -m 755 
INSTALL_DIR     = $(INSTALL) -m 755 -d 
INSTALL_DATA    = $(INSTALL) -m 644 
INSTALL_KEYRING	= $(INSTALL) -m 600 

# Handy defines 
VERSION         = $(shell echo `awk '{ print $$1 }' version`)

# For subdirs, required exports 
export PREFIX 
export MANPATH

all:: $(OBJECTS)
	cp $(OBJECTS) ..

# default compile rule:
%.pyc: %.py
	python -c "import py_compile; py_compile.compile('$<')"

$(DIRS):
	@$(INSTALL_DIR) $@

rhn_applet_version.py: version
	echo '# This file is a portion of the Red Hat Network Panel Applet'>$@
	echo '# autogenerated' >> $@
	echo "version='"`awk '{ print $$1 }' $<`"'" >> $@
	echo "release='"`awk '{ print $$2 }' $<`"'" >> $@

install:: all $(DIRS)
	$(INSTALL_DIR) $(RHNSHARE_DIR)/
	$(INSTALL_BIN) $(PYLIBFILES) $(RHNSHARE_DIR)/
	$(descend-subdirs)

%.o : %.c
	$(CC) -fPIC $(CFLAGS) -c -o $@ $<
%.so : %.o
	$(CC) -shared $(LIBS) -Wl,-soname,$@ $< -o $@

distdir: $(DISTFILES)
	for file in $(DISTFILES); do \
		test -f $(distdir)/$$file \
		|| cp -p $$file $(distdir)/$$file \
		|| exit 1; \
	done

clean:
	@rm -fv *.pyc *~ .*~ *.o *.so core* *.desktop
	@find . -name .\#\* -exec rm -fv {} \;

# useful macro
descend-subdirs = @$(foreach d,$(SUBDIRS), $(MAKE) -C $(d) $@ || exit 1; )

# Now do the same in the subdirs
#all clean install :: $(SUBDIRS)
#	$(descend-subdirs)

# OTHER targets for internal use
pychecker:: 
	@$(PYCHECKER) $(PYFILES) || exit 0
graphviz:: 
	@$(PYCHECKER) -Z $(PYFILES) || exit 0

# Import the RHN build system macros
PROJECT		= applet
-include ../../Makefile.inc
